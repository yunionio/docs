---
title: "物理机测试方案"
date: 2019-07-19T20:25:05+08:00
weight: 100
description: >
  物理机功能的测试方案和用例
---

## 1. 环境要求

### 1.1 物理机设置

物理机设置要求如下：

1) 物理机的启动方式推荐采用legacy（BIOS）方式，UEFI方式不推荐。只有在必须采用UEFI时才选用UEFI。

2) 物理机的默认启动方式为网络PXE启动，硬盘启动为第二顺位的启动介质

3) 需要允许物理机网卡的PXE启动（BIOS开启IPMI-over-LAN）

4) 需要允许网络访问物理机的BMC（BIOS开启网卡PXE）

### 1.2 测试网络设置

物理服务器的网络接口（NIC）分为BMC NIC和服务器NIC，BMC NIC用于通过网络访问物理机的BMC控制功能，BMC NIC可以配置为和服务器NIC共享物理机接口，也可以配置为独立的网络接口。

<img src="../baremetal_test.png" width="700">
 
其中，交换机0为部署服务的节点接入的三层交换机，交换机1为待管理物理服务器的服务器NIC接入三层交换机，交换机2为待管理物理服务器的BMC NIC接入三层交换机。

此处，交换机0，1，2可以是同一个三层交换机，这是最简化的场景，也就是服务节点、待管理交换机的服务器NIC、以及BMC NIC都在一个二层网络内。

一般物理机服务器采用bonding需要配置双NIC接入。目前只支持802.3ad LACP模式，也就是mode为4的bond。如果要支持bond这种模式，需要物理机的两个NIC都接入交换机1，此处交换机1可能是一对堆叠交换机。

### 1.3 IP子网设置

需要在平台做如下配置用于物理机的IP地址分配：新建物理机用二层网络（如：brbm），如果物理机BMC NIC和物理机 NIC的二层网络隔离，则需新建BMC NIC用二层网络 brbmc。在二层网络brbm上新建属性为baremetal或PXE的IP子网（vbm），用于分配物理机NIC的IP地址。在二层网络brbmc（或bmbm）上新建属性为IPMI的 IP子网，用于分配BMC NIC的IP地址（vbmc）。

连通性要求：要求baremetal agent能够直接访问vbm和vbmc的IP地址。

### 1.4 交换机设置

为了允许物理机能够网络PXE启动，需要设置交换机1的dhcp_relay为bareemetal_agent所在节点IP地址的UDP 67端口。

如果采用“预注册”方式注册物理机，则也需要设置交换机2的dhcp_relay为baremetal_agent所在节点IP地址的UDP 67端口。

在最简网络模式下，依旧是上文所说的服务和待管理物理机在同一个IP子网的网络配置下，如果不方便开启三层交换机的dhcp_relay，则可以借用{{<oem_name>}}的Host服务，开启其dhcp_relay功能，作为测试IP子网的dhcp relay服务器。具体开启方法为：修改该Host服务所在宿主机的配置文件 /etc/yunion/host.conf，增加 dhcp_relay 的配置项，内容为baremetal_agent部署节点IP的UDP 67端口。配置好后，记得重启该host服务。

```yaml
dhcp_relay:
- 192.168.222.101
- 67
```

### 1.5 物理机硬件信息要求

需要提前准备好物理机的如下信息：

1) 如果采用PXE引导注册或预注册的物理服务器，需要第一个网络PXE启动的物理机 NIC的mac地址
2) 如果采用PXE引导注册或ISO引导注册，需要物理机的BMC NIC的IP地址和BMC 账号，密码。


## 2. 测试流程

### 2.1 物理机注册

物理机注册实现将一台物理机注册到云平台，云平台会引导物理机启动进入一个网络加载的内存Linux系统，通过该Linux接管物理机，实现自动采集物理机的配置信息，并注册到平台。

支持如下四种注册方式：

#### 2.1.1 PXE引导注册(推荐方式)

物理机已经配置BMC NIC的IP，通过BMC控制物理服务器通过PXE协议引导物理机网络启动进入内存Linux系统。这种方式依赖PXE网络启动，因此要求设置交换机1的dhcp_relay。

#### 2.1.2 ISO引导注

物理机已经配置BMC NIC的IP，通过物理机的虚拟ISO介质引导物理机启动进入内存Linux系统。这种方式不依赖PXE启动，因此不要求设置交换机1的dhcp_relay。但是要求物理机支持设置BMC的虚拟机ISO介质，一般只有最新的少数物理服务器支持，例如HPE Gen10。

#### 2.1.3 预注册

和PXE引导注册类似，但是物理机未配置BMC NIC的IP。这种方式会自动设置BMC NIC的IP，需要探测BMC NIC的连通性，因此需要设置交换机2的dhcp_relay。

#### 2.1.4 托管

这种方式适用于已经安装了操作系统，不适合进行开关机操作的物理服务器的注册。这种方式只支持物理服务器上已安装系统为Linux。这种方式要求管理员在物理服务器的操作系统内执行指定的脚本命令，并输入物理服务器的BMC NIC IP和密码，实现物理服务器的注册。

### 2.2 物理机安装操作系统

使用上述注册的物理机安装操作系统。我们将安装了操作系统的物理机成为“裸金属”服务器。

注意：

1) 如果物理服务器采用双网卡接入，可以测试自动设置网卡的bonding模式，此时网卡需要勾选“bond”选项
2) 新安装的操作系统的IP地址可以复用物理服务器PXE启动注册用的PXE IP地址，此时选择网络需要注册还是选择PXE IP子网。

### 2.3 安装物理机监控agent

在“裸金属”服务器的监控面板，安装监控agent，查看物理机是否有监控指标数据。

### 2.4 删除操作系统

删除“裸金属”服务器上安装的操作系统，成为一台“闲置”的物理机
