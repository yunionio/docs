---
title: "监控"
date: 2019-07-19T17:38:36+08:00
weight: 12
---

平台支持两种监控宿主机上虚拟机的信息，一是通过宿主机获取虚拟机的监控信息，该方式获取的监控数据误差较大，二是为虚拟机安装Agent，像虚拟机内存使用率、磁盘使用率指标无法直接通过宿主机获取，需要安装监控Agent。

## 原理

监控 Agent 是运行在虚拟机上的 daemon，采集监控数据，并把数据传回{{<oem_name>}}的 InfluxDB。

由此，可以衍生出三个问题：如何安装 Agent，如何采集数据，以及如何传输监控数据。

### 如何安装 Agent

{{<oem_name>}}使用 Ansible 将 Agent 安装到虚拟机上，为了能够做到这一点，我们需要保证 {{<oem_name>}} 能够连接到虚拟机并且能够登录到虚拟机；这里我们先假设{{<oem_name>}}能够过连接到虚拟机，故而来优先讨论解决登录问题。

![host_install](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805163249.png)

#### 如何登录虚拟机

假设{{<oem_name>}}已经能够连接到 VPC 内部的虚拟机，内置私有云默认可以直接连接到VPC内部虚拟机，比如说其他如公有云等需要通过 NAT网关或者虚拟机已经绑定了 EIP 等。

![connect_direct](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805163416.png)

###### 直接免密登录

如果虚拟机是通过{{<oem_name>}}平台创建出来的，那么{{<oem_name>}}是可以直接免密登录到虚拟机，
它是通过在虚拟机上自动创建一个可以通过公钥登录的 cloudroot 用户而实现的，对应的
私钥存储在{{<oem_name>}}的本地数据库。

###### 用户协助配置免密登录

如果虚拟机并非通过{{<oem_name>}}平台创建出来的，那么就需要用户协助设置置免密登录了。

用户需要在前端相关界面输入虚拟机的用户名和密钥/密码，以使{{<oem_name>}}能够暂时登录到
目标虚拟机，然后借助 Ansible 在目标虚拟机上创建 cloudroot 用户并配置公钥登录。

![set_root](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805164138.png)

同理，其实也可以直接让用户在虚拟机上执行脚本，以达到创建 cloudroot 用户以及配置
公钥登录的目的。

![exec_script](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805164239.png)


#### 如何连接虚拟机

{{<oem_name>}}不能直接连接到虚拟机，是一种最广泛的情况。比如公有云 VPC 内部且没有配置Nat 以及 EIP 的虚拟机。对于此种情况，我们使用 SSH 代理，具体来说是 Local Port 
Forwarding。

###### SSH Local Port Forwarding 

![question1](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805165213.png)

假设网络 A 和网络 B 是两个隔离的网络，如果想让 VMA 能够访问 VMB 上监听在 80 端口
的 web 服务应该怎么办呢？

在 proxyA 上执行

```bash
ssh –NfL 10.127.30.251:12345:172.31.25.194:80  cloudroot@140.179.54.109
```


上面的命令会在 proxyA 和 proxyB 之间建立 SSH隧道，并在 proxyA 上创建一个 port forwarding，
它将监听`10.127.30.251:12345`，一旦有请求发来，就会通过 SSH 隧道转发到 proxyB，
proxyB 会把请求转发到`172.31.25.194:80`

![answer1](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805165029.png)

然后 VMA 只要访问`10.127.30.251:12345`就能够访问 VMB 上的 web 服务。

### 如何收集数据

我们的监控数据存储在 InfluxDB 中，所以采集数据的 Agent 优先选择了 Telegraf，在其
基础上修改了一些代码并定制了配置文件以满足{{<oem_name>}}采集数据的要求。

配置主要描述了需要什么样的监控数据，数据的标签以及数据存储的地址。

### 如何传输监控数据

最简单的，如果虚拟机可以直接连接到{{<oem_name>}}中的 InfluxDB，那么数据就可以直接传输
回来。

在安装 Agent 的过程中，{{<oem_name>}}回去检测是否可以从虚拟机直接访问 InfluxDB，如何不
可以，就要使用 SSH 代理，具体来说是 Remote Port Forwarding。

#### SSH Remote Port Forwarding

![question2](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805165957.png)

网络 A 和网络 B 是两个隔离的网络，proxyB 具有公网 IP，所以 proxyA 可以访问到 proxyB，
如何让 VMB 访问 DB？

在 proxyA 上执行:
```bash
ssh –NfR 172.31.25.194:12345:10.127.40.251:30086  cloudroot@140.179.54.109
```

上面的命令会在 proxyA 和 proxyB 之间建立 SSH 隧道，并在 proxyB 上创建一个 port 
forwarding，它将监听`172.31.25.194:12345`，一旦有请求发来，就会通过 SSH 隧道转
发到 proxyA，proxyA 会把请求转发到`10.172.40.251:80`

![answer2](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805170059.png)

通过上面的方式，网络B 内部的 VMB 只要访问`172.31.25.194:12345`就可以访问到 DB。

总结来说，Local Port Forwarding 和 Remote Port Forwarding 的区别在于，Port 
Forwarding 建立的位置对于执行命令的一方来说是 Local 还是 Remote。

#### 传输数据

在 proxy 和 proxyVM 之间建立 SSH 隧道，并在 proxy 执行命令以在 proxyVM 上建立 
port fowarding，对 proxy 来说就是 remote port forwarding。

VPC 内部的虚拟机就可以通过访问 proxyVM 的 port，访问{{<oem_name>}}的 DB 以把数据传输
回来。


![tarnsfer](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805170450.png)

### 总结

总结来说，对于大多数情况，{{<oem_name>}}通过 SSH 代理连接到目标虚拟机，借助 Ansible 将
监控 Agent 安装到目标虚拟机上，并做好 Agent 的配置，而监控数据数据也将通过 SSH 
代理传回到{{<oem_name>}}中的 InfluxDB 中。

![summarize](https://rainzm-1258344290.cos.ap-beijing.myqcloud.com/20210805170928.png)

## 界面操作

### 安装监控Agent

当平台上虚拟机已默认直接免密登录时，可以直接安装Agent。

1. 在虚拟机页面，单击虚拟机名称项，进入虚拟机详情页面。
2. 单击“监控”页签，进入监控页面。
3. 单击 **_"安装Agent"_** 按钮，弹出安装Agent按钮。
4. 开始探测虚拟机的免密登录状态。
    - 当虚拟机可以免密登录时，单击 **_"确定"_** 按钮，安装Agent。
        - 当虚拟机所在VPC或IP中存在SSH代理节点时，将会直接安装Agent。
        - 当虚拟机所在VPC或IP中不存在SSH代理节点时，将会安装Agent失败，并提示创建SSH代理节点。
    - 当虚拟机不可免密登录时，请先将虚拟机设置为免密登录状态。

{{% alert title="说明" %}}
当Agent安装失败后，可以将鼠标移到到“安装失败，可尝试重新安装”上，将会展示Agent安装失败的具体原因。
{{% /alert %}}

### 设置免密登录

该功能用于将虚拟机设置为能被平台免密登录。虚拟机能被平台免密登录，则要求虚拟机与平台网络通（即通过EIP、NAT网关或SSH代理等方式使虚拟机与平台网络通）以及虚拟机中存在平台的公钥文件。设置免密登录功能仅用于将平台的公钥拷贝到虚拟机中，请先确保虚拟机与平台网络通。

**设置免密登录**

1. 在虚拟机页面，单击虚拟机右侧操作列 **_"更多"_** 按钮，选择 **_"密码密钥-设置免密登录"_** 菜单项，弹出设置免密登录对话框。
2. 配置以下参数：
    - 设置方式：支持密钥、密码、脚本等方式将平台的公钥上传到虚拟机上。
    - 当设置方式为“密钥”时，请使用root用户或具有使用sudo免密权限的用户以其私钥，请确保可以通过用户名和私钥通过ssh连接到对应虚拟机，单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
    - 当设置方式为“密码”时，请使用root用户或具有使用sudo免密权限的用户以其密码，请确保可以通过用户名和密码通过ssh连接到对应虚拟机。单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
    - 当设置方式为“脚本”时，请请使用root或具有sudo权限的用户在虚拟机中执行以下脚本，执行完成后，单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
3. 若虚拟机可以免密登录，直接单击 **_"关闭"_** 按钮。
4. 若虚拟机仍不可免密登录，请在操作列表查看不可免密登录的原因。
    - 如报错原因中提示“Failed to connect to the host via ssh”，则需要先将该虚拟机通过绑定EIP或NAT网关以及SSH代理等方式，使其与平台网络可通。
    - 如报错原因中提示“Permission denied”，则表示输入的信息错误，可单击 **_"上一步"_** 按钮，修改配置，继续设置并探测。


**批量设置免密登录**

只支持批量为同一项目下的虚拟机设置免密登录。

1. 在虚拟机列表中选择一个或多个虚拟机，单击列表上方 **_"批量操作"_** 按钮，选择下拉菜单 **_"密码密钥-设置免密登录"_** 菜单项，弹出设置免密登录对话框。
2. 配置以下参数：
    - 设置方式：支持密钥、密码、脚本等方式将平台的公钥上传到虚拟机上。
    - 当设置方式为“密钥”时，请使用root用户或具有使用sudo免密权限的用户以其私钥，请确保可以通过用户名和私钥通过ssh连接到对应虚拟机，单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
    - 当设置方式为“密码”时，请使用root用户或具有使用sudo免密权限的用户以其密码，请确保可以通过用户名和密码通过ssh连接到对应虚拟机。单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
    - 当设置方式为“脚本”时，请请使用root或具有sudo权限的用户在虚拟机中执行以下脚本，执行完成后，单击 **_"确定"_** 按钮，进入等待执行结果页面，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
3. 若虚拟机可以免密登录，直接单击 **_"关闭"_** 按钮。
4. 若虚拟机仍不可免密登录，请在操作列表查看不可免密登录的原因。
    - 如报错原因中提示“Failed to connect to the host via ssh”，则需要先将该虚拟机通过绑定EIP、NAT网关以或SSH代理等方式，使其与平台网络可通。
    - 如报错原因中提示“Permission denied”，则表示输入的信息错误，可单击 **_"上一步"_** 按钮，修改配置，继续设置并探测。

### 探测免密登录

该功能用于探测虚拟机是否能被平台免密登录。

**探测免密登录**

1. 在虚拟机页面，单击虚拟机右侧操作列 **_"更多"_** 按钮，选择 **_"密码密钥-探测免密登录"_** 菜单项，弹出探测免密登录对话框。
2. 开始探测免密登录，并支持在操作列表查看不可免密登录的原因。
    - 如报错原因中提示“none publickey”，可通过设置免密登录功能，将虚拟机设置为免密登录状态。
    - 如报错原因中提示“network error”，则需要先将该虚拟机通过绑定EIP或NAT网关以及SSH代理等方式，使其与平台网络可通。

**批量探测免密登录**

1. 在虚拟机列表中选择一个或多个虚拟机，单击列表上方 **_"批量操作"_** 按钮，选择下拉菜单 **_"密码密钥-探测免密登录"_** 菜单项，弹出探测免密登录对话框。
2. 开始探测免密登录，并支持在操作列表查看不可免密登录的原因。
    - 如报错原因中提示“none publickey”，可通过设置免密登录功能，将虚拟机设置为免密登录状态。
    - 如报错原因中提示“network error”，则需要先将该虚拟机通过绑定EIP或NAT网关以及SSH代理等方式，使其与平台网络可通。

### 新建SSH代理节点

该功能用于新建代理节点。

1. 在SSH代理节点页面，单击列表上方 **_"新建"_** 按钮，进入新建SSH代理节点页面。
2. 在选择虚拟机页面设置以下参数：
    - 域：设置SSH代理节点所属域，并通过域过滤可选的虚拟机。
    - 名称：设置SSH代理节点的名称。
    - 区域：通过平台、区域过滤VPC。
    - 网络：通过VPC、网络过滤虚拟机。
    - 虚拟机：通过上面的筛选条件过滤出符合条件的虚拟机，并支持在搜索框中通过名称和IP搜索虚拟机，请确保所选的虚拟机符合[虚拟机配置要求](#虚拟机配置要求)，如没有合适的虚拟机，可以单击“新建”超链接，跳转到虚拟机列表页面创建符合需求的虚拟机。
3. 选择好虚拟机后，单击 **_"下一步"_** 按钮，开始探测虚拟机的免密登录状态。
    - 如虚拟机可免密登录，可直接单击 **_"确定"_** 按钮，开始创建虚拟机。
    - 如虚拟机不可免密登录，请先点击列表操作列 **_"查看"_** 按钮，查看探测免密登录失败的具体原因。
        - 如报错原因中提示“none publickey”，可通过设置免密登录功能，将虚拟机设置为免密登录状态。设置免密登录方式配置参数如下：
            - 设置方式：支持密钥、密码、脚本等方式将平台的公钥上传到虚拟机上。
            - 当设置方式为“密钥”时，请使用root用户或具有使用sudo免密权限的用户以其私钥，请确保可以通过用户名和私钥通过ssh连接到对应虚拟机，单击 **_"确定"_** 按钮，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
            - 当设置方式为“密码”时，请使用root用户或具有使用sudo免密权限的用户以其密码，请确保可以通过用户名和密码通过ssh连接到对应虚拟机。单击 **_"确定"_** 按钮，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
            - 当设置方式为“脚本”时，请请使用root或具有sudo权限的用户在虚拟机中执行以下脚本，执行完成后，单击 **_"确定"_** 按钮，开始设置并探测虚拟机的免密登录状态是否变为免密登录。
        - 如报错原因中提示“network error”，则需要返回上一步选择其他虚拟机，或为该虚拟机通过绑定EIP或NAT网关等方式，使其与平台网络可通。
4. 只有当虚拟机免密登录状态为“可免密登录”时，才支持单击 **_"确定"_** 按钮，开始创建SSH代理节点。
5. 在创建SSH代理节点时将会检查虚拟机的sshd配置是否符合虚拟机配置要求，若不符合将会尝试变更虚拟机的sshd配置，因此可能会造成创建ssh代理节点时间过长，若提示超时，请重新单击 **_"确定"_** 按钮，创建SSH代理节点。

#### 虚拟机配置要求

- 目前只支持Linux操作系统的虚拟机作为SSH代理节点。
- 请确保虚拟机处于运行中状态；
- 请确保虚拟机支持通过平台免密登录；虚拟机能被平台免密登录，则要求虚拟机与平台网络通（即通过EIP、NAT网关或SSH代理等方式使虚拟机与平台网络通）以及虚拟机中存在平台的公钥文件。
- 请检查虚拟机的sshd配置，GatewayPorts是clientspecified，若该项值为no，则只允许绑定127.0.0.1的地址，使remote forward无法正常使用，造成安装监控Agent的虚拟机无法向平台上报监控数据等。


