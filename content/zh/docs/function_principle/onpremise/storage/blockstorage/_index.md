---
title: "块存储"
date: 2021-06-25T10:53:20+08:00
weight: 10
description: >
  KVM虚拟机，裸金属和VMware使用的块存储
---

块存储为虚拟机提供虚拟磁盘的存储。

其中，支持的存储访问接口分为以下几类：

* 文件接口：虚拟机的磁盘以文件形式存在，QEMU虚拟机通过Posix文件接口来访问虚拟机磁盘文件的内容。磁盘文件格式一般有raw，qcow2两种格式。我们一般采用qcow2的格式的磁盘文件。qcow2格式的磁盘文件相比于raw格式文件有很多优点：1）支持thin provision模式，磁盘文件占用空间按需分配，2）支持快照，3）性能优异。

* 块接口：虚拟机的磁盘就是宿主机上的磁盘设备。虚拟机直接挂载宿主机上的block设备。这些block设备无论是本地还是网络共享的，都会加入到宿主机的LVM VG存储池中，以LVM的逻辑卷提供给QEMU虚拟机。基于KVM的快照实现了虚拟机磁盘的快照。相比文件接口方式，这种方式少了文件系统的开销，有较高的读写性能。

* 自定义接口：文件接口和快接口都是Linux操作系统的标准接口，除此之外，Cloudpods支持的访问虚拟磁盘的接口为Ceph RBD，是Ceph自定义的访问其分布式块设备的接口。

从存储的部署架构，分为如下几类：

* 本地访问：虚拟机磁盘存储在宿主机本地挂载的存储上，例如本地的SATA, SAS或NVME块设备
* 网络访问：虚拟机磁盘存储在宿主机网络挂载的集中式存储上，例如NFS，GPFS，OCFS2等
* 分布式访问：虚拟机磁盘不存储在本地或网络上的具体存储节点上，而是分布式在多个节点上，例如Ceph。

因此，块存储从访问接口和部署架构，分为如下几类。

| 部署架构        |  本地访问           | 集中式网络访问       | 去中心分布式访问 |
| 访问接口        |                  |                    |                |
|----------------|-------------------|--------------------|----------------|
| 文件接口        | 本地存储            | NAS                |                |
| 块接口          | 本地LVM            | LVM                |                |
| 自定义接口       |                   |                    | Ceph RBD       |


## 本地存储

本地存储是使用宿主机本地的文件系统存储虚拟机的磁盘文件。是默认支持的块存储。本地存储需要在宿主机的本地配置文件申明，host服务启动后会自动注册和上报状态。具体具体配置和使用方法请参考 [本地存储](./add-storage)。

## NAS

NAS存储使用网络挂载的文件系统存储虚拟机的磁盘文件。目前分为两种情况NFS和GPFS。

### NFS

NFS类型的块存储特指通过NFS协议挂载的网络共享文件系统。这一类存储需要指定共享的服务器IP和共享目录。将宿主机和存储关联后，host服务会自动以NFS协议挂载该存储到宿主机的指定目录，无需提前手动挂载。

### GPFS

GPFS用于指定用户已经手动提前挂载到宿主机的任意网络共享文件系统，并不仅限于GPFS，还包括OCFS2，GlusterFS等网络文件系统。创建一个GPFS类型的块存储的意义更多是用于将存储的配置信息提供给平台，便于后续使用。跟NFS存储不同，将该存储挂载到宿主机的操作，其作用仅是告知平台该存储在宿主机的访问路径，平台并不会自动执行挂载。只要是用户自己执行挂载的网络文件系统，都可以注册为GPFS类型的块存储。

## 本地LVM

本地LVM是使用宿主机本机的LVM VG分配逻辑卷给虚拟机作为虚拟磁盘的块存储。具体配置和使用方法参考 [本机LVM存储](./lvm-storage)。

## Ceph

Ceph是使用Ceph RBD块设备作为虚拟机的虚拟磁盘。具体配置和使用方法参考 [Ceph](./ceph)